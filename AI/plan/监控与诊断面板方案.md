# 监控与诊断面板方案（待评审）

## 目标
在设置页新增一个“监控与诊断”入口按钮，点击后打开一个独立详情页，集中展示应用运行与数据状态，帮助定位“素材库丢失/数据库异常/权限异常/性能问题”。

---

## 入口与交互
- 设置页新增按钮：`监控与诊断`（按钮在“数据存储”或“性能状态”下方）
- 点击后打开新页面（推荐 `sheet` 或 `NavigationDestination`）
- 页面内按模块分组展示指标 + 操作按钮

---

## 可监控内容清单（建议版本）

### 1) SwiftData 数据库
**展示**
- 数据库文件路径（可复制）
- 文件大小（字节/MB）
- 最后修改时间
- 表统计（素材/相册/规则/历史记录数量）
- 数据库是否可读/可写

**操作**
- 打开数据库文件
- 打开所在文件夹
- 复制路径
- 导出数据库快照（可选）

---

### 2) 素材库健康状态
**展示**
- 总素材数（图片/视频分别）
- 最近导入时间
- 最近一次失败导入记录（日志汇总）
- 文件存在性检查（抽样/全量）

**操作**
- 快速修复：扫描数据库中不存在的文件并标记/移除
- 重新同步（尝试恢复权限）

---

### 3) 权限与安全访问
**展示**
- 是否有安全作用域书签
- 最近一次权限错误时间
- 文件访问失败次数

**操作**
- 重新授权目录
- 清理损坏书签

---

### 4) 更新系统状态
**展示**
- 当前版本
- 更新源地址
- 上次检查时间
- 上次下载结果

**操作**
- 立即检查更新
- 打开下载目录

---

### 5) 性能与资源
**展示**
- CPU、内存（现有 PerformanceMonitor）
- 缩略图缓存大小
- 视频壁纸运行状态

**操作**
- 清理缩略图缓存
- 停止视频壁纸

---

## UI 结构建议
- 顶部：总览卡片（版本号、设备、时间）
- 中间：分区卡片（SwiftData / 素材库 / 权限 / 更新 / 性能）
- 每个卡片：左侧标题 + 内容列表 + 右侧操作按钮

---

## 技术实现要点
- SwiftData 统计：使用 `@Query` 或 `ModelContext` 查询数量
- 文件信息：`FileManager` 获取 size/modified date
- 权限与失败记录：从 `LogCenter` 中提取关键日志
- 详情页：独立 SwiftUI View（例如 `DiagnosticsView`）

---

## 评审问题（请确认）
1. 详情页使用 `sheet` 还是 `NavigationDestination`？ NavigationDestination
2. 数据库修复动作是否允许自动删除“已丢失文件”的记录？(允许)
3. 是否需要导出数据库快照？暂时不需要
4. 是否要把“日志”也整合到这个页面？ (需要, 优先级最高,)

---

## 产出预期
- 设置页新增入口按钮
- 新页面展示上述模块
- 初期只读信息 + 基本操作（打开文件夹/复制路径/检查更新）
- 后续迭代增加“修复”和“导出”
