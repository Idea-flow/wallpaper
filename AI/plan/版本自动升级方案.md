# 版本自动升级方案（待评审）

## 目标
- 为 macOS App 提供可靠的自动升级能力，支持静默检测、手动触发更新、下载并替换应用。
- 兼容沙盒/非沙盒构建，保证用户可感知的更新体验与错误回退。

## 推荐方案（优先）
### 方案 A：集成 Sparkle 2（标准且成熟）
**原因**：
- macOS 上最成熟的自动更新框架，支持签名验证、增量更新、静默/手动检查、多渠道发布。
- 社区成熟，长期维护。

**能力**：
- 自动检查更新（定时/启动时/手动）
- 支持 delta 更新（节省流量）
- 支持发布渠道（稳定/测试）
- 更新包签名验证，安全性高

**实现大纲**：
1. 集成 Sparkle 2（Swift Package 或二进制）
2. 为应用配置 AppCast（XML），并在服务器托管（GitHub Releases/自建）
3. 生成更新签名（ed25519）
4. 在设置页提供：
   - 自动检查开关
   - 手动检查按钮
   - 当前版本显示
5. 更新时在主窗口或菜单栏提示

**依赖**：
- Sparkle Framework
- AppCast 托管（GitHub Releases / S3 / 自建静态站点）

**风险**：
- 沙盒模式需要额外 entitlement 配置
- 需要更新签名流程

---

## 备选方案
### 方案 B：自研更新器
**思路**：
- 通过远端 JSON 获取版本信息
- 下载新版本 dmg/zip
- 校验 hash
- 提示用户关闭后替换应用

**优点**：
- 高度可控、依赖少

**缺点**：
- 实现成本高
- 替换逻辑容易出错
- 安全性与合规性成本更高

---

## 技术细节（方案 A：Sparkle）
### 1. AppCast 结构
- `appcast.xml`：包含版本号、下载地址、签名、发布日期、更新说明。

### 2. 签名
- 使用 Sparkle 提供的 `sign_update` 工具生成签名。
- 更新包必须与签名匹配。

### 3. UI/交互
- 设置页：
  - 自动检查更新开关
  - “检查更新”按钮
  - 当前版本号
- 菜单栏：提供“检查更新”入口

### 4. 更新流程
1. 应用启动/定时检查 AppCast
2. 有新版本 → 弹窗提示
3. 用户确认 → 下载并替换
4. 自动重启或提示重启

---

## 评审重点
- 是否接受 Sparkle 作为依赖
- 更新托管方式（GitHub Releases vs 自建）
- 是否支持测试渠道（内测分支）
- 更新提示与交互是否需要“强制更新”策略

---

## 下一步（待你确认）
- 确认采用方案 A 或 B
- 确认更新包托管方式
- 确认是否要内测/稳定双通道
