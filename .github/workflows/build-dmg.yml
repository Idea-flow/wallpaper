name: Build DMG

permissions:
  contents: write

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build Release App
        run: |
          # 禁用代码签名以避免 CI 中缺少签名证书导致构建失败。
          # 如果你需要生产签名（发布到 App Store 或有签名需求），请参考下方说明并在 workflow 中安装证书与 provisioning profile。
          xcodebuild \
            -project wallpaper.xcodeproj \
            -scheme wallpaper \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            clean build

      - name: Create DMG
        run: |
          APP_NAME="wallpaper"
          APP_PATH="build/Build/Products/Release/${APP_NAME}.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "App not found at $APP_PATH"
            exit 1
          fi

          # Prepare a temporary read-write image
          DMG_TMP="${APP_NAME}-temp.dmg"
          SIZE="100m"
          EMPTY_DIR=$(mktemp -d)
          hdiutil create -srcfolder "$EMPTY_DIR" -size "$SIZE" -fs HFS+ -volname "$APP_NAME" -ov -format UDRW "$DMG_TMP"
          rm -rf "$EMPTY_DIR"

          # Attach the image and get mount point
          MOUNT_POINT=$(hdiutil attach -readwrite -noverify -noautoopen "$DMG_TMP" | egrep '/Volumes/' | sed -E 's/.*\t(\/Volumes\/.*)/\1/' | head -n1)
          if [ -z "$MOUNT_POINT" ]; then
            echo "Failed to attach temporary image"
            exit 1
          fi

          # Copy the app into the mounted image
          cp -R "$APP_PATH" "$MOUNT_POINT/"

          # Fallback: create a symbolic link to /Applications so there's an item even when AppleScript cannot run in CI
          if [ ! -e "$MOUNT_POINT/Applications" ]; then
            ln -s /Applications "$MOUNT_POINT/Applications" || true
          fi

          # Try to create a Finder alias to /Applications (alias may carry the standard Applications icon) using AppleScript
          # Note: on headless CI the AppleScript may fail silently; we keep the symlink fallback above.
          osascript <<AS || true
          tell application "Finder"
            try
              set appFolder to POSIX file "/Applications"
              set targetFolder to POSIX file "$MOUNT_POINT"
              make alias file to appFolder at targetFolder
              set name of result to "Applications"
            end try
          end tell
          AS

          # Create a clickable shell command to fix quarantine attributes
          FIX_CMD="$MOUNT_POINT/FixCannotOpen.command"
          cat > "$FIX_CMD" <<'EOF'
          #!/bin/bash
          xattr -cr '/Applications/wallpaper.app'
          osascript -e 'display notification "修复已执行" with title "wallpaper"'
          EOF
          chmod +x "$FIX_CMD"

          # Optional: add a tiny README or hint file (hidden)
          echo "将应用拖到 Applications 以安装。若打开失败，请双击 FixCannotOpen.command。" > "$MOUNT_POINT/README.txt"

          # Arrange icons and window appearance via AppleScript so users see App on left, Fix button center, Applications on right
          osascript <<AS || true
          tell application "Finder"
            tell disk "$APP_NAME"
              open
              set current view of container window to icon view
              set toolbar visible of container window to false
              set statusbar visible of container window to false
              set the bounds of container window to {100, 100, 800, 420}
              set viewOptions to the icon view options of container window
              set arrangement of viewOptions to not arranged
              set icon size of viewOptions to 128

              -- position items by name
              try
                set position of item "${APP_NAME}.app" of container window to {120, 160}
              end try
              try
                set position of item "FixCannotOpen.command" of container window to {360, 160}
              end try
              try
                set position of item "Applications" of container window to {600, 160}
              end try

              close
              open
              update without registering applications
            end tell
          end tell
          AS

          # Detach and convert to compressed DMG
          hdiutil detach "$MOUNT_POINT"
          hdiutil convert "$DMG_TMP" -format UDZO -imagekey zlib-level=9 -o "${APP_NAME}.dmg"
          rm -f "$DMG_TMP"

          echo "Created ${APP_NAME}.dmg"

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Use a run-specific tag to avoid clobbering existing releases
          tag_name: "artifact-${{ github.run_number }}"
          release_name: "artifact-${{ github.run_number }}"
          body: "Automated release for run ${{ github.run_id }} (artifact wallpaper.dmg)"
          draft: false
          prerelease: false

      - name: Upload DMG to Release
        id: upload_release_asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: wallpaper.dmg
          asset_name: wallpaper.dmg
          asset_content_type: application/octet-stream

      - name: Print Release asset download URL
        run: |
          echo "Release 页面: ${{ steps.create_release.outputs.html_url }}"
          echo "Release 标签: ${{ steps.create_release.outputs.tag_name }}"
          echo "资产浏览下载 URL: ${{ steps.upload_release_asset.outputs.browser_download_url }}"
          echo "在浏览器中打开上述 URL 可直接下载；若使用 curl，可运行："
          echo "curl -L -o wallpaper.dmg \"${{ steps.upload_release_asset.outputs.browser_download_url }}\""
