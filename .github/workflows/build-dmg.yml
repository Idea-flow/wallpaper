name: Build DMG

permissions:
  contents: write

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    env:
      APP_NAME: "wallpaper"
      APP_VERSION: "1.2.2"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build Release App
        run: |
          # 禁用代码签名以避免 CI 中缺少签名证书导致构建失败。
          # 如果你需要生产签名（发布到 App Store 或有签名需求），请参考下方说明并在 workflow 中安装证书与 provisioning profile。
          xcodebuild \
            -project wallpaper.xcodeproj \
            -scheme wallpaper \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            clean build

      - name: Create DMG
        run: |
          APP_NAME="wallpaper"
          APP_VERSION="${{ env.APP_VERSION }}"
          APP_PATH="build/Build/Products/Release/${APP_NAME}.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "App not found at $APP_PATH"
            exit 1
          fi

          # Prepare a temporary read-write image
          DMG_TMP="${APP_NAME}-temp.dmg"
          SIZE="100m"
          EMPTY_DIR=$(mktemp -d)
          hdiutil create -srcfolder "$EMPTY_DIR" -size "$SIZE" -fs HFS+ -volname "$APP_NAME" -ov -format UDRW "$DMG_TMP"
          rm -rf "$EMPTY_DIR"

          # Attach the image and get mount point
          MOUNT_POINT=$(hdiutil attach -readwrite -noverify -noautoopen "$DMG_TMP" | egrep '/Volumes/' | sed -E 's/.*\t(\/Volumes\/.*)/\1/' | head -n1)
          if [ -z "$MOUNT_POINT" ]; then
            echo "Failed to attach temporary image"
            exit 1
          fi

          # Copy the app into the mounted image
          cp -R "$APP_PATH" "$MOUNT_POINT/"

          # Fallback: create a symbolic link to /Applications so there's an item even when AppleScript cannot run in CI
          if [ ! -e "$MOUNT_POINT/Applications" ]; then
            ln -s /Applications "$MOUNT_POINT/Applications" || true
          fi

           # Create a clickable shell command to fix quarantine attributes
          FIX_CMD="$MOUNT_POINT/FixCannotOpen.command"
          cat > "$FIX_CMD" <<'EOF'
          #!/bin/bash
          xattr -cr '/Applications/wallpaper.app'
          osascript -e 'display notification "修复已执行" with title "wallpaper"'
          EOF
          chmod +x "$FIX_CMD"

          # Detach and convert to compressed DMG
          FINAL_DMG="${APP_NAME}-${APP_VERSION}.dmg"
          hdiutil detach "$MOUNT_POINT"
          hdiutil convert "$DMG_TMP" -format UDZO -imagekey zlib-level=9 -o "$FINAL_DMG"
          rm -f "$DMG_TMP"

          echo "Created ${FINAL_DMG}"

      - name: Create GitHub Release and upload asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ env.APP_VERSION }}"
          name: "${{ env.APP_NAME }} ${{ env.APP_VERSION }}"
          body: "Automated release for ${{ env.APP_NAME }} v${{ env.APP_VERSION }} (artifact ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.dmg)"
          files: ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print Release asset download URL
        run: |
          echo "Release 页面: https://github.com/${{ github.repository }}/releases/tag/v${{ env.APP_VERSION }}"
          echo "Release 标签: v${{ env.APP_VERSION }}"
          echo "资产浏览下载 URL: https://github.com/${{ github.repository }}/releases/download/v${{ env.APP_VERSION }}/${{ env.APP_NAME }}-${{ env.APP_VERSION }}.dmg"
          echo "在浏览器中打开上述 URL 可直接下载；若使用 curl，可运行："
          echo "curl -L -o ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.dmg \"https://github.com/${{ github.repository }}/releases/download/v${{ env.APP_VERSION }}/${{ env.APP_NAME }}-${{ env.APP_VERSION }}.dmg\""
